name: Image refresh

run-name: Deployment@${{ github.ref_name }} - ${{ github.run_id }}

on:
    push:
        branches:
            - "master"
            - "dev"

jobs:
    Deploy:
        runs-on: self-hosted
        environment: ${{ github.ref_name }}
        steps:
            - name: Extract branch name
              shell: bash
              run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
              id: extract_branch
            - name: Pull fresh environment variables - master
              run: export INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id=${{ secrets.MACHINE_IDENTITY_CLIENT_ID }} --client-secret=${{ secrets.MACHINE_IDENTITY_CLIENT_SECRET }} --silent --plain --domain=https://pass.andreihudalla.ru) && infisical export --domain=https://pass.andreihudalla.ru --projectId=8898adfd-2ebc-4d0f-9f64-6fa06d5de1ea --env=master --format=dotenv-export > ./.env.master
              working-directory: /home/fred/school.550
            - name: Pull fresh environment variables - dev
              run: export INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id=${{ secrets.MACHINE_IDENTITY_CLIENT_ID }} --client-secret=${{ secrets.MACHINE_IDENTITY_CLIENT_SECRET }} --silent --plain --domain=https://pass.andreihudalla.ru) && infisical export --domain=https://pass.andreihudalla.ru --projectId=8898adfd-2ebc-4d0f-9f64-6fa06d5de1ea --env=dev --format=dotenv-export > ./.env.dev
              working-directory: /home/fred/school.550
            - name: Make copy of .env for Nuxt runtime config
              run: cp .env.${{ steps.extract_branch.outputs.branch }} .env
              working-directory: /home/fred/school.550
            - name: Pull fresh images
              run: docker compose pull
              working-directory: /home/fred/school.550
            - name: Shutdown application
              run: docker compose down --remove-orphans
              working-directory: /home/fred/school.550
            - name: Run application
              run: docker compose up -d
              working-directory: /home/fred/school.550